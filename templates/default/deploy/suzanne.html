<!doctype html>
<html>
<head>
  <title>Threeflow</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="js/dat.gui.js"></script>

  <script src="js/three.js"></script>
  <script src="js/threeflow.js"></script>

  <script src="js/OrbitControls.js"></script>
  <script src="js/TransformControls.js"></script>

  <script src="js/SubdivisionModifier.js"></script>

</head>
<style>
  body{
    background-color: #131313;
    margin:0px;
    padding:0px;
    overflow:scroll;
  }
</style>
<body>
<script>

  var width, height, threeflow, lighting, gui;
  var camera, scene, renderer;

  init();
  update();

  function init() {

    // ###
    // Threeflow Basic setup

    width = 800; height = 600;

    threeflow = new THREEFLOW.SunflowRenderer({overwrite:true});
    threeflow.setSize( width,height );

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( width,height );

    document.body.appendChild( renderer.domElement );
    var img = document.body.appendChild( document.createElement("img") );
    img.src = "renders/suzanne.png";

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera( 35, width/height, 1, 30000 );
    camera.position.set(0,500,1000);
    camera.lookAt( new THREE.Vector3() );

    lighting = new THREEFLOW.LightingRig(camera,renderer.domElement);
    lighting.loadState('{"keyRadiance":6,"lights":[{"enabled":true,"color":16777199,"keyRatio":0,"radiance":6,"geometryType":"Plane","target":{"x":-35.976463217623866,"y":114.9826472459399,"z":14.76779791261201},"light":{"x":-378.8596143373222,"y":290.20328094958063,"z":447.80734704797476,"sx":1,"sy":1,"sz":1}},{"enabled":true,"color":16777199,"keyRatio":2,"radiance":3,"geometryType":"Plane","target":{"x":217.81041418261862,"y":60.59184047682686,"z":0},"light":{"x":784.9189739195299,"y":204.48885431421434,"z":218.80207442818107,"sx":1.1760563915268067,"sy":1.1760563915268067,"sz":1.1760563915268067}},{"enabled":true,"color":16777199,"keyRatio":1,"radiance":6,"geometryType":"Plane","target":{"x":-207.30188165286313,"y":32.48094818666641,"z":-131.85555947333944},"light":{"x":-769.2943168229731,"y":381.50515397250257,"z":-894.6262734630952,"sx":0.7378484368043043,"sy":0.7378484368043043,"sz":0.7378484368043043}},{"enabled":true,"color":16777199,"keyRatio":8,"radiance":0.75,"geometryType":"Plane","target":{"x":405.4561720515609,"y":128.06773481919686,"z":-716.9348712525214},"light":{"x":762.4879099396458,"y":310.9158695184617,"z":-409.34363940372657,"sx":1.1752789471525573,"sy":1.1752789471525573,"sz":1.1752789471525573}}]}')
    scene.add( lighting );

    gui = new THREEFLOW.Gui(threeflow,lighting);
    gui.onRender.add( function(){
      threeflow.render( scene, camera, "suzanne" );
    });

    // ###
    // Add scene stuff.

    // Material Spheres

    var geometry, material, mesh, spheres, materialTypes,materialType;
    var size,radius,theta, i, count;

    size = 30;
    geometry = new THREE.SphereGeometry(size,size);
    geometry.computeBoundingBox();
    count = 18;
    radius = ((size*2)*(count+4))/(Math.PI*2);

    spheres = new THREE.Object3D();

    materialTypes = [ THREEFLOW.ConstantMaterial, THREEFLOW.ShinyMaterial, THREEFLOW.DiffuseMaterial, THREEFLOW.MirrorMaterial, THREEFLOW.PhongMaterial, THREEFLOW.GlassMaterial ];

    for( i = 0; i<count; i++ )
    {
      materialType = materialTypes[ i%materialTypes.length ];
      material = new materialType();

      if( material instanceof THREEFLOW.ConstantMaterial ){
        material.color.setRGB(1,1,1); // Set to white / ConstantMaterial acts as a subtle light source when GI is enabled
      }else{
        material.color.setHSL(i/count,.7,.5);
      }

      mesh = new THREE.Mesh(geometry,material);
      theta = ((Math.PI*2)/count)*i;

      mesh.position.x = radius * Math.cos(theta);
      mesh.position.y = -geometry.boundingBox.min.y;
      mesh.position.z = radius * Math.sin(theta);
      spheres.add(mesh);
    }

    // rotate to bring nicer colours around to front.
    spheres.rotation.y = Math.PI/2;
    scene.add(spheres);

    // Suzanne

    var loader = new THREE.JSONLoader();

    loader.load("models/suzanne.json",function(geometry){
      var subdiv = new THREE.SubdivisionModifier(2);
      subdiv.modify(geometry);
      geometry.computeBoundingBox();

      var scale = 200 / ( geometry.boundingBox.max.y - geometry.boundingBox.min.y );
      material = new THREEFLOW.ShinyMaterial();
      mesh = new THREE.Mesh(geometry,material);

      mesh.scale.set(scale,scale,scale);
      mesh.position.y = (geometry.boundingBox.max.y*0.535)*scale;
      mesh.rotation.order = "YXZ";
      mesh.rotation.x = -(Math.PI/5); // rotate so flat on the floor.
      mesh.rotation.y = Math.PI/12;

      scene.add(mesh);
    });
  }

  function update() {
    requestAnimationFrame( update );

    lighting.update();
    renderer.render( scene, camera );
  }

</script>
</body>
</html>